--- zfs-zfs-0.8.1/config/zfs-build.m4.orig	2019-06-14 18:43:18.000000000 +0200
+++ zfs-zfs-0.8.1/config/zfs-build.m4	2019-07-17 16:03:44.885415916 +0200
@@ -110,7 +110,7 @@
 		[enable_debug_kmem=no])
 
 	AS_IF([test "x$enable_debug_kmem" = xyes], [
-		KERNEL_DEBUG_CPPFLAGS+=" -DDEBUG_KMEM"
+		KERNEL_DEBUG_CPPFLAGS="$KERNEL_DEBUG_CPPFLAGS -DDEBUG_KMEM"
 		DEBUG_KMEM_ZFS="_with_debug_kmem"
 	], [
 		DEBUG_KMEM_ZFS="_without_debug_kmem"
@@ -140,7 +140,7 @@
 		[enable_debug_kmem_tracking=no])
 
 	AS_IF([test "x$enable_debug_kmem_tracking" = xyes], [
-		KERNEL_DEBUG_CPPFLAGS+=" -DDEBUG_KMEM_TRACKING"
+		KERNEL_DEBUG_CPPFLAGS="$KERNEL_DEBUG_CPPFLAGS -DDEBUG_KMEM_TRACKING"
 		DEBUG_KMEM_TRACKING_ZFS="_with_debug_kmem_tracking"
 	], [
 		DEBUG_KMEM_TRACKING_ZFS="_without_debug_kmem_tracking"
@@ -242,10 +242,10 @@
 	])
 
 	RPM_DEFINE_COMMON='--define "$(DEBUG_ZFS) 1"'
-	RPM_DEFINE_COMMON+=' --define "$(DEBUG_KMEM_ZFS) 1"'
-	RPM_DEFINE_COMMON+=' --define "$(DEBUG_KMEM_TRACKING_ZFS) 1"'
-	RPM_DEFINE_COMMON+=' --define "$(DEBUGINFO_ZFS) 1"'
-	RPM_DEFINE_COMMON+=' --define "$(ASAN_ZFS) 1"'
+	RPM_DEFINE_COMMON="$RPM_DEFINE_COMMON"' --define "$(DEBUG_KMEM_ZFS) 1"'
+	RPM_DEFINE_COMMON="$RPM_DEFINE_COMMON"' --define "$(DEBUG_KMEM_TRACKING_ZFS) 1"'
+	RPM_DEFINE_COMMON="$RPM_DEFINE_COMMON"' --define "$(DEBUGINFO_ZFS) 1"'
+	RPM_DEFINE_COMMON="$RPM_DEFINE_COMMON"' --define "$(ASAN_ZFS) 1"'
 
 	RPM_DEFINE_UTIL=' --define "_initconfdir $(DEFAULT_INITCONF_DIR)"'
 
@@ -258,16 +258,16 @@
 		RPM_DEFINE_UTIL='--define "_dracutdir $(dracutdir)"'
 	])
 	AS_IF([test -n "$udevdir" ], [
-		RPM_DEFINE_UTIL+=' --define "_udevdir $(udevdir)"'
+		RPM_DEFINE_UTIL="$RPM_DEFINE_UTIL"' --define "_udevdir $(udevdir)"'
 	])
 	AS_IF([test -n "$udevruledir" ], [
-		RPM_DEFINE_UTIL+=' --define "_udevdir $(udevruledir)"'
+		RPM_DEFINE_UTIL="$RPM_DEFINE_UTIL"' --define "_udevdir $(udevruledir)"'
 	])
-	RPM_DEFINE_UTIL+=' $(DEFINE_INITRAMFS)'
-	RPM_DEFINE_UTIL+=' $(DEFINE_SYSTEMD)'
-	RPM_DEFINE_UTIL+=' $(DEFINE_PYZFS)'
-	RPM_DEFINE_UTIL+=' $(DEFINE_PYTHON_VERSION)'
-	RPM_DEFINE_UTIL+=' $(DEFINE_PYTHON_PKG_VERSION)'
+	RPM_DEFINE_UTIL="$RPM_DEFINE_UTIL"' $(DEFINE_INITRAMFS)'
+	RPM_DEFINE_UTIL="$RPM_DEFINE_UTIL"' $(DEFINE_SYSTEMD)'
+	RPM_DEFINE_UTIL="$RPM_DEFINE_UTIL"' $(DEFINE_PYZFS)'
+	RPM_DEFINE_UTIL="$RPM_DEFINE_UTIL"' $(DEFINE_PYTHON_VERSION)'
+	RPM_DEFINE_UTIL="$RPM_DEFINE_UTIL"' $(DEFINE_PYTHON_PKG_VERSION)'
 
 	dnl # Override default lib directory on Debian/Ubuntu systems.  The
 	dnl # provided /usr/lib/rpm/platform/<arch>/macros files do not
@@ -279,14 +279,14 @@
 	dnl #
 	AS_IF([test "$DEFAULT_PACKAGE" = "deb"], [
 		MULTIARCH_LIBDIR="lib/$(dpkg-architecture -qDEB_HOST_MULTIARCH)"
-		RPM_DEFINE_UTIL+=' --define "_lib $(MULTIARCH_LIBDIR)"'
+		RPM_DEFINE_UTIL="$RPM_DEFINE_UTIL"' --define "_lib $(MULTIARCH_LIBDIR)"'
 		AC_SUBST(MULTIARCH_LIBDIR)
 	])
 
 	RPM_DEFINE_KMOD='--define "kernels $(LINUX_VERSION)"'
-	RPM_DEFINE_KMOD+=' --define "ksrc $(LINUX)"'
-	RPM_DEFINE_KMOD+=' --define "kobj $(LINUX_OBJ)"'
-	RPM_DEFINE_KMOD+=' --define "_wrong_version_format_terminate_build 0"'
+	RPM_DEFINE_KMOD="$RPM_DEFINE_KMOD"' --define "ksrc $(LINUX)"'
+	RPM_DEFINE_KMOD="$RPM_DEFINE_KMOD"' --define "kobj $(LINUX_OBJ)"'
+	RPM_DEFINE_KMOD="$RPM_DEFINE_KMOD"' --define "_wrong_version_format_terminate_build 0"'
 
 	RPM_DEFINE_DKMS=''
 
From db0ad393b1bb7f83167e1cece1fd896dd0e63d73 Mon Sep 17 00:00:00 2001
From: "Andrew J. Hesford" <48421688+ahesford@users.noreply.github.com>
Date: Fri, 14 Feb 2020 11:30:29 -0500
Subject: [PATCH] Use POSIX stdout/stderr redirect in configure macro

This PR fixes an issue wherein redirecting stdout and stderr when
building kernel modules in configure tests relied on a bashism that
does not work as expected when /bin/sh is not bash.

Reviewed-by: George Melikov <mail@gmelikov.ru>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-By: Richard Laager <rlaager@wiktel.com>
Signed-off-by: Andrew J. Hesford <ajh@sideband.org>
Closes #9990
Closes #9998
---
 config/kernel.m4 | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/config/kernel.m4 b/config/kernel.m4
index 23643e0c3de..6bb37937cb4 100644
--- a/config/kernel.m4
+++ b/config/kernel.m4
@@ -566,7 +566,7 @@ AC_DEFUN([ZFS_LINUX_COMPILE], [
 	AC_TRY_COMMAND([
 	    KBUILD_MODPOST_NOFINAL="$5" KBUILD_MODPOST_WARN="$6"
 	    make modules -k -j$TEST_JOBS -C $LINUX_OBJ $ARCH_UM
-	    M=$PWD/$1 &>$1/build.log])
+	    M=$PWD/$1 >$1/build.log 2>&1])
 	AS_IF([AC_TRY_COMMAND([$2])], [$3], [$4])
 ])
 
